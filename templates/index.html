{% extends "base.html" %}
{% block title %}Standard Proposals - Nobel Biocare{% endblock %}

{% block extra_style %}
.discount-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
}
.discount-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
}
.discount-item label { font-size: 12px; margin-bottom: 3px; }
.discount-item input { padding: 7px; font-size: 13px; }

.quick-nav {
    background: #f0f4f8;
    padding: 10px 14px;
    border-radius: 6px;
    margin-bottom: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}
.quick-nav-label { font-weight: 600; color: #666; font-size: 12px; }
.quick-nav a {
    background: #003087;
    color: white;
    padding: 4px 10px;
    border-radius: 14px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
}
.quick-nav a:hover { background: #004099; }

.search-box { margin-bottom: 16px; }
.search-box input { width: 100%; padding: 12px; font-size: 15px; }

.category-section { margin-bottom: 14px; }
.category-title {
    background: #f0f4f8;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #003087;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}
.category-title:hover { background: #e5ebf1; }
.category-title .arrow { transition: transform 0.3s; }
.category-title.open .arrow { transform: rotate(180deg); }
.products-list { display: none; margin-top: 8px; }
.products-list.open { display: block; }
.product-row {
    display: grid;
    grid-template-columns: 1fr 80px 90px;
    gap: 12px;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
}
.product-row:hover { background: #f9fafb; }
.product-desc { font-size: 13px; }
.product-id { color: #888; font-size: 11px; }
.product-price { color: #003087; font-weight: 600; text-align: right; font-size: 13px; }
.qty-input { width: 65px; padding: 6px; text-align: center; font-size: 13px; }

.output-options { display: flex; gap: 20px; margin: 16px 0; }
.output-option { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; }
.output-option input { width: 16px; height: 16px; }

.selected-count {
    background: #00A3E0;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}
.preset-btn {
    padding: 6px 14px;
    margin-right: 6px;
    border: 2px solid #003087;
    background: white;
    color: #003087;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    font-size: 13px;
}
.preset-btn:hover { background: #f0f4f8; }
.preset-btn.clear { border-color: #999; color: #666; }

.bone-mill-row, .addon-row {
    display: grid;
    grid-template-columns: 1fr 100px 90px;
    gap: 12px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('generate') }}" id="proposalForm">
    <div class="card">
        <h2>Proposal Details</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Account Name *</label>
                <input type="text" name="account_name" required placeholder="e.g., Smith Dental">
            </div>
            <div class="form-group">
                <label>Territory Manager</label>
                <input type="text" name="rep_name" placeholder="Your name">
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>Discounts by Category</h2>
        <p style="color: #666; margin: -8px 0 16px; font-size: 13px;">Set discount percentages per product category</p>
        <div style="margin-bottom: 14px;">
            <button type="button" class="preset-btn" onclick="applyPreset('standard')">Standard (30/25/20)</button>
            <button type="button" class="preset-btn" onclick="applyPreset('aggressive')">Aggressive (40/35/30)</button>
            <button type="button" class="preset-btn" onclick="applyPreset('light')">Light (20/15/10)</button>
            <button type="button" class="preset-btn clear" onclick="applyPreset('clear')">Clear All</button>
        </div>
        <div class="discount-grid">
            {% for group in discount_groups %}
            <div class="discount-item">
                <label>{{ group }} %</label>
                <input type="number" id="discount_{{ group.replace(' ', '_').replace('-', '_') }}" 
                       name="discount_{{ group.replace(' ', '_').replace('-', '_') }}" 
                       value="0" min="0" max="100" step="1">
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="card">
        <h2>Select Products <span class="selected-count" id="selectedCount">0 selected</span></h2>
        <div class="quick-nav">
            <span class="quick-nav-label">Jump to:</span>
            {% for cat in categories %}
            <a href="#" onclick="jumpTo('{{ cat }}'); return false;">{{ cat.replace('Capital - ', '').split(' ')[0] }}</a>
            {% endfor %}
        </div>
        <div class="search-box">
            <input type="text" id="productSearch" placeholder="ðŸ” Search products by name or item #...">
        </div>
        
        {% for category, prods in products.items() %}
        <div class="category-section" data-category="{{ category }}" id="cat-{{ category | replace(' ', '-') | replace('/', '-') }}">
            <div class="category-title" onclick="toggleCategory(this)">
                <span>{{ category }} ({{ prods|length }})</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="products-list">
                {% for prod in prods %}
                <div class="product-row" data-search="{{ prod.description|lower }} {{ prod.id|lower }}">
                    <div>
                        <div class="product-desc">{{ prod.description }}</div>
                        <div class="product-id">{{ prod.id }}</div>
                    </div>
                    <div class="product-price">${{ "{:,.0f}".format(prod.price) }}</div>
                    <input type="number" class="qty-input" name="qty_{{ prod.id }}" min="0" value="0" onchange="updateCount()">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Bone Mills Section -->
    <div class="card">
        <h2>Bone Mills (Add-on)</h2>
        <p style="color: #666; margin: -8px 0 12px; font-size: 13px;">Bone mills are NOT included in standard PureSet kits. Add them here.</p>
        {% for bm in bone_mills %}
        <div class="bone-mill-row">
            <div>
                <div class="product-desc">{{ bm.description }}</div>
                <div class="product-id">{{ bm.id }}</div>
            </div>
            <div class="product-price">${{ "{:,.0f}".format(bm.price) }}</div>
            <input type="number" class="qty-input" name="qty_{{ bm.id }}" min="0" value="0" onchange="updateCount()">
        </div>
        {% endfor %}
    </div>
    
    <!-- Additional Tooling Section -->
    <div class="card">
        <h2>Additional Tooling (Add-on)</h2>
        <p style="color: #666; margin: -8px 0 12px; font-size: 13px;">Drill kits, screw taps, retrieval sets, and other individual tools.</p>
        {% for tool in addon_tools %}
        <div class="addon-row">
            <div>
                <div class="product-desc">{{ tool.description }}</div>
                <div class="product-id">{{ tool.id }}</div>
            </div>
            <div class="product-price">${{ "{:,.0f}".format(tool.price) }}</div>
            <input type="number" class="qty-input" name="qty_{{ tool.id }}" min="0" value="0" onchange="updateCount()">
        </div>
        {% endfor %}
    </div>
    
    <div class="card">
        <h2>Notes / Comments</h2>
        <div class="form-group">
            <label>Add notes or special terms (optional)</label>
            <textarea name="notes" rows="3" style="resize: vertical;" placeholder="e.g., Pricing valid for 30 days."></textarea>
        </div>
    </div>
    
    <div class="card">
        <h2>Output Format</h2>
        <div class="output-options">
            <label class="output-option">
                <input type="radio" name="output_format" value="docx" checked>
                <span>ðŸ“„ Word (.docx)</span>
            </label>
            <label class="output-option">
                <input type="radio" name="output_format" value="pdf">
                <span>ðŸ“• PDF</span>
            </label>
        </div>
        <button type="submit" class="btn btn-primary btn-full">Generate Proposal</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
function applyPreset(preset) {
    const presets = {
        'standard': { Implants: 30, Abutments: 25, Kits: 20, Grafting: 20, Membranes: 20, Sutures: 15, '3Shape': 10, SprintRay: 10, DEXIS: 10, 'X_Guide': 10, iCAM: 10, DTX: 10, Other: 15 },
        'aggressive': { Implants: 40, Abutments: 35, Kits: 30, Grafting: 30, Membranes: 30, Sutures: 25, '3Shape': 15, SprintRay: 15, DEXIS: 15, 'X_Guide': 15, iCAM: 15, DTX: 15, Other: 25 },
        'light': { Implants: 20, Abutments: 15, Kits: 10, Grafting: 10, Membranes: 10, Sutures: 10, '3Shape': 5, SprintRay: 5, DEXIS: 5, 'X_Guide': 5, iCAM: 5, DTX: 5, Other: 10 },
        'clear': { Implants: 0, Abutments: 0, Kits: 0, Grafting: 0, Membranes: 0, Sutures: 0, '3Shape': 0, SprintRay: 0, DEXIS: 0, 'X_Guide': 0, iCAM: 0, DTX: 0, Other: 0 }
    };
    const values = presets[preset];
    if (!values) return;
    for (const [group, val] of Object.entries(values)) {
        const input = document.getElementById('discount_' + group);
        if (input) input.value = val;
    }
}

function jumpTo(categoryName) {
    const sections = document.querySelectorAll('.category-section');
    for (const section of sections) {
        if (section.dataset.category === categoryName) {
            section.querySelector('.products-list').classList.add('open');
            section.querySelector('.category-title').classList.add('open');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
    }
}

function toggleCategory(el) {
    el.classList.toggle('open');
    el.nextElementSibling.classList.toggle('open');
}

function updateCount() {
    let count = 0;
    document.querySelectorAll('.qty-input').forEach(input => {
        if (parseInt(input.value) > 0) count++;
    });
    document.getElementById('selectedCount').textContent = count + ' selected';
}

document.getElementById('productSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.product-row').forEach(row => {
        row.style.display = row.dataset.search.includes(query) ? '' : 'none';
    });
    document.querySelectorAll('.category-section').forEach(cat => {
        if (query && cat.querySelectorAll('.product-row:not([style*="display: none"])').length > 0) {
            cat.querySelector('.products-list').classList.add('open');
            cat.querySelector('.category-title').classList.add('open');
        }
    });
});
</script>
{% endblock %}
