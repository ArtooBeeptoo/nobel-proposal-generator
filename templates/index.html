{% extends "base.html" %}
{% block title %}Standard Proposals - Nobel Biocare{% endblock %}

{% block extra_style %}
.discount-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
}
.discount-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
}
.discount-item label { font-size: 12px; margin-bottom: 3px; }
.discount-item input { padding: 7px; font-size: 13px; }

.quick-nav {
    background: #f5f5f0;
    padding: 10px 14px;
    border-radius: 6px;
    margin-bottom: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}
.quick-nav-label { font-weight: 600; color: #666; font-size: 12px; }
.quick-nav a {
    background: #000;
    color: white;
    padding: 4px 10px;
    border-radius: 14px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
}
.quick-nav a:hover { background: #333; }

.search-box { margin-bottom: 16px; }
.search-box input { width: 100%; padding: 12px; font-size: 15px; }

.category-section { margin-bottom: 14px; }
.category-title {
    background: #f5f5f0;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}
.category-title:hover { background: #eee; }
.category-title .arrow { transition: transform 0.3s; }
.category-title.open .arrow { transform: rotate(180deg); }
.products-list { display: none; margin-top: 8px; }
.products-list.open { display: block; }

.product-row {
    display: grid;
    grid-template-columns: 1fr 80px 90px;
    gap: 12px;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
}
@media (max-width: 600px) {
    .product-row {
        grid-template-columns: 1fr 70px 60px;
        gap: 6px;
        padding: 8px 6px;
    }
    .product-desc { font-size: 12px; }
    .product-price { font-size: 12px; }
    .qty-input { width: 50px; padding: 5px; font-size: 12px; }
}
.product-row:hover { background: #f9fafb; }
.product-desc { font-size: 13px; }
.product-id { color: #888; font-size: 11px; }
.product-price { color: #000; font-weight: 600; text-align: right; font-size: 13px; }
.qty-input { width: 65px; padding: 6px; text-align: center; font-size: 13px; }

.output-options { display: flex; gap: 20px; margin: 16px 0; }
.output-option { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; }
.output-option input { width: 16px; height: 16px; }

.selected-count {
    background: #FED880;
    color: #000;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}
.preset-btn {
    padding: 6px 14px;
    margin-right: 6px;
    border: 2px solid #000;
    background: white;
    color: #000;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    font-size: 13px;
}
.preset-btn:hover { background: #f5f5f0; }
.preset-btn.clear { border-color: #999; color: #666; }

.bone-mill-row, .addon-row, .motor-row, .kit-row {
    display: grid;
    grid-template-columns: 1fr 100px 90px;
    gap: 12px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}
@media (max-width: 600px) {
    .bone-mill-row, .addon-row, .motor-row, .kit-row {
        grid-template-columns: 1fr 70px 60px;
        gap: 6px;
    }
}

/* Kit section styling */
.kit-section { margin-bottom: 20px; }
.kit-section h3 {
    font-size: 15px;
    color: #333;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
}

/* Component tooltip */
.has-tooltip { cursor: help; position: relative; }
.has-tooltip .product-desc { border-bottom: 1px dashed #999; display: inline; }
.tooltip-content {
    display: none;
    position: absolute;
    left: 0; top: 100%;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 14px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 100;
    width: 400px;
    max-height: 400px;
    overflow-y: auto;
    font-size: 12px;
}
@media (max-width: 600px) {
    .tooltip-content { width: 280px; font-size: 11px; }
}
.has-tooltip:hover .tooltip-content,
.tooltip-content.pinned { display: block; }
.tooltip-content h4 { margin: 0 0 8px; font-size: 13px; color: #000; }
.tooltip-content .comp-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #f0f0f0; }
.tooltip-content .comp-article { color: #888; font-size: 11px; }
.tooltip-content .comp-section { font-weight: 600; margin: 8px 0 4px; color: #000; font-size: 12px; }
.tooltip-content .comp-total { font-weight: 700; margin-top: 8px; padding-top: 6px; border-top: 2px solid #000; }

/* Save/Load bar */
.save-bar {
    background: #f5f5f0;
    padding: 10px 14px;
    border-radius: 6px;
    margin-bottom: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}
.save-bar button {
    padding: 6px 14px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}
.save-bar button:hover { background: #eee; }
.save-bar select { padding: 6px; font-size: 13px; }

/* Section badge */
.section-badge {
    background: #FED880;
    color: #000;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
}

/* Recommendation banner */
.recommendation {
    background: #FFF8E1;
    border-left: 4px solid #FED880;
    padding: 10px 14px;
    border-radius: 0 6px 6px 0;
    margin: 10px 0;
    font-size: 13px;
}
.recommendation strong { color: #000; }
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('generate') }}" id="proposalForm">
    <!-- Save/Load Bar -->
    <div class="save-bar">
        <button type="button" onclick="saveQuote()">ðŸ’¾ Save Quote</button>
        <button type="button" onclick="loadQuoteList()">ðŸ“‚ Load Quote</button>
        <select id="savedQuotes" style="display:none;" onchange="loadQuote(this.value)">
            <option value="">Select a saved quote...</option>
        </select>
        <span id="saveStatus" style="font-size:12px;color:#666;"></span>
    </div>

    <div class="card">
        <h2>Proposal Details</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Account Name *</label>
                <input type="text" name="account_name" id="account_name" required placeholder="e.g., Smith Dental">
            </div>
            <div class="form-group">
                <label>Territory Manager</label>
                <input type="text" name="rep_name" id="rep_name" placeholder="Your name">
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>Discounts by Category</h2>
        <p style="color: #666; margin: -8px 0 16px; font-size: 13px;">Set discount percentages per product category</p>
        <div style="margin-bottom: 14px;">
            <button type="button" class="preset-btn" onclick="applyPreset('standard')">Standard (30/25/20)</button>
            <button type="button" class="preset-btn" onclick="applyPreset('aggressive')">Aggressive (40/35/30)</button>
            <button type="button" class="preset-btn" onclick="applyPreset('light')">Light (20/15/10)</button>
            <button type="button" class="preset-btn clear" onclick="applyPreset('clear')">Clear All</button>
        </div>
        <div class="discount-grid">
            {% for group in discount_groups %}
            <div class="discount-item">
                <label>{{ group }} %</label>
                <input type="number" id="discount_{{ group.replace(' ', '_').replace('-', '_') }}" 
                       name="discount_{{ group.replace(' ', '_').replace('-', '_') }}" 
                       value="0" min="0" max="100" step="0.01">
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- â•â•â• SURGICAL KITS â•â•â• -->
    <div class="card">
        <h2>Surgical Kits <span class="section-badge">Complete Pricing</span></h2>
        <p style="color:#666;margin:-8px 0 12px;font-size:13px;">Prices include base kit + all add-on components (drills, screw taps, bone mills). Hover over any kit to see full component list.</p>
        
        <div class="kit-section">
            <h3>Freehand Surgical Kits</h3>
            {% for kid in ['87294','87295','87296','87469','87293'] %}
            {% set kit = all_kits.get(kid, {}) %}
            {% if kit %}
            <div class="kit-row has-tooltip">
                <div>
                    <div class="product-desc">{{ kit.name }}</div>
                    <div class="product-id">{{ kit.bom }}{% if kit.addon_price %} Â· Base ${{ "{:,.0f}".format(kit.bom_price) }} + Add-ons ${{ "{:,.0f}".format(kit.addon_price) }}{% endif %}</div>
                    <div class="tooltip-content" onclick="event.stopPropagation()">
                        <h4>{{ kit.name }}</h4>
                        {% if kit.notes %}<p style="color:#666;margin-bottom:8px;">{{ kit.notes }}</p>{% endif %}
                        {% if kit.base_components %}
                        <div class="comp-section">Base Kit ({{ kit.bom }}) â€” ${{ "{:,.0f}".format(kit.bom_price) }}</div>
                        {% for c in kit.base_components %}
                        <div class="comp-row"><span>{{ c.desc }} <span class="comp-article">{{ c.article }}{% if c.qty > 1 %} Ã—{{ c.qty }}{% endif %}</span></span><span>${{ "{:,.0f}".format(c.price) }}</span></div>
                        {% endfor %}
                        {% endif %}
                        {% if kit.addon_components %}
                        <div class="comp-section">Add-on Components â€” ${{ "{:,.0f}".format(kit.addon_price) }}</div>
                        {% for c in kit.addon_components %}
                        <div class="comp-row"><span>{{ c.desc }} <span class="comp-article">{{ c.article }}{% if c.qty > 1 %} Ã—{{ c.qty }}{% endif %}</span></span><span>${{ "{:,.0f}".format(c.price) }}</span></div>
                        {% endfor %}
                        {% endif %}
                        <div class="comp-total">Complete Kit: ${{ "{:,.0f}".format(kit.complete_price) }}</div>
                    </div>
                </div>
                <div class="product-price">${{ "{:,.0f}".format(kit.complete_price) }}</div>
                <input type="number" class="qty-input" name="qty_{{ kid }}" min="0" value="0" onchange="updateCount()">
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div class="kit-section">
            <h3>NobelPearl</h3>
            <div class="kit-row">
                <div>
                    <div class="product-desc">NobelPearl Tapered Surgery Kit</div>
                    <div class="product-id">301267 Â· Complete kit â€” all drills included</div>
                </div>
                <div class="product-price">$3,845</div>
                <input type="number" class="qty-input" name="qty_301267" min="0" value="0" onchange="updateCount()">
            </div>
        </div>

        <div class="kit-section">
            <h3>Guided Surgery Kits</h3>
            {% for kid in ['87305','87306','87307'] %}
            {% set kit = guided_kits.get(kid, {}) %}
            {% if kit %}
            <div class="kit-row has-tooltip">
                <div>
                    <div class="product-desc">{{ kit.name }}</div>
                    <div class="product-id">{{ kit.bom }} Â· Base ${{ "{:,.0f}".format(kit.bom_price) }} + Add-ons ${{ "{:,.0f}".format(kit.addon_price) }}</div>
                    <div class="tooltip-content">
                        <h4>{{ kit.name }}</h4>
                        <p style="color:#666;margin-bottom:8px;">{{ kit.notes }}</p>
                        <div class="comp-total">Complete Kit: ${{ "{:,.0f}".format(kit.complete_price) }}</div>
                    </div>
                </div>
                <div class="product-price">${{ "{:,.0f}".format(kit.complete_price) }}</div>
                <input type="number" class="qty-input" name="qty_{{ kid }}" min="0" value="0" onchange="updateCount()">
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div class="kit-section">
            <h3>Zygomatic Kits</h3>
            {% for kid, kit in zygomatic_kits.items() %}
            <div class="kit-row">
                <div>
                    <div class="product-desc">{{ kit.name }}</div>
                    <div class="product-id">{{ kit.bom }}{% if kit.notes %} Â· {{ kit.notes }}{% endif %}</div>
                </div>
                <div class="product-price">${{ "{:,.0f}".format(kit.complete_price) }}</div>
                <input type="number" class="qty-input" name="qty_{{ kid }}" min="0" value="0" onchange="updateCount()">
            </div>
            {% endfor %}
        </div>

        <div class="kit-section">
            <h3>Prosthetic Kits</h3>
            {% for kid, kit in prosthetic_kits.items() %}
            <div class="kit-row has-tooltip">
                <div>
                    <div class="product-desc">{{ kit.name }}</div>
                    <div class="product-id">{{ kit.bom }} Â· {{ kit.notes }}</div>
                    {% if kit.base_components %}
                    <div class="tooltip-content">
                        <h4>{{ kit.name }}</h4>
                        {% for c in kit.base_components %}
                        <div class="comp-row"><span>{{ c.desc }} <span class="comp-article">{{ c.article }}</span></span><span>${{ "{:,.0f}".format(c.price) }}</span></div>
                        {% endfor %}
                        <div class="comp-total">Total: ${{ "{:,.0f}".format(kit.bom_price) }}</div>
                    </div>
                    {% endif %}
                </div>
                <div class="product-price">${{ "{:,.0f}".format(kit.bom_price) }}</div>
                <input type="number" class="qty-input" name="qty_{{ kid }}" min="0" value="0" onchange="updateCount()">
            </div>
            {% endfor %}
        </div>

        <div class="kit-section">
            <h3>Legacy Kits</h3>
            {% for kid in ['87297','87298','87299'] %}
            {% set kit = all_kits.get(kid, {}) %}
            {% if kit %}
            <div class="kit-row">
                <div>
                    <div class="product-desc">{{ kit.name }}</div>
                    <div class="product-id">{{ kit.bom }} Â· Complete (base + add-ons)</div>
                </div>
                <div class="product-price">${{ "{:,.0f}".format(kit.complete_price) }}</div>
                <input type="number" class="qty-input" name="qty_{{ kid }}" min="0" value="0" onchange="updateCount()">
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- â•â•â• MOTORS â•â•â• -->
    <div class="card">
        <h2>Motors <span class="section-badge">NEW</span></h2>
        <p style="color:#666;margin:-8px 0 12px;font-size:13px;">Surgical motor systems. Hover for component breakdown.</p>
        {% for mid, motor in motors.items() %}
        <div class="motor-row has-tooltip">
            <div>
                <div class="product-desc">{{ motor.name }}</div>
                <div class="product-id">{{ motor.bom }}</div>
                <div class="tooltip-content">
                    <h4>{{ motor.name }}</h4>
                    {% for c in motor.components %}
                    <div class="comp-row"><span>{{ c.desc }} <span class="comp-article">{{ c.article }}</span></span><span>${{ "{:,.0f}".format(c.price) }}</span></div>
                    {% endfor %}
                    <div class="comp-total">Total: ${{ "{:,.0f}".format(motor.price) }}</div>
                </div>
            </div>
            <div class="product-price">${{ "{:,.0f}".format(motor.price) }}</div>
            <input type="number" class="qty-input" name="qty_{{ mid }}" min="0" value="0" onchange="updateCount()">
        </div>
        {% endfor %}
    </div>

    <!-- â•â•â• TOOLING / ADD-ON SETS â•â•â• -->
    <div class="card">
        <h2>Tooling & Add-on Sets</h2>
        <p style="color:#666;margin:-8px 0 12px;font-size:13px;">Bone mill sets, drill kits, screw taps, and guided components. Order alongside kits or individually.</p>
        {% for aid, addon in addon_sets.items() %}
        <div class="addon-row">
            <div>
                <div class="product-desc">{{ addon.name }}</div>
                <div class="product-id">{{ aid }}{% if addon.notes %} Â· {{ addon.notes }}{% endif %}</div>
            </div>
            <div class="product-price">${{ "{:,.0f}".format(addon.price) }}</div>
            <input type="number" class="qty-input" name="qty_{{ aid }}" min="0" value="0" onchange="updateCount()">
        </div>
        {% endfor %}
    </div>

    <!-- â•â•â• DRILL STOPS & RETRIEVAL â•â•â• -->
    <div class="card">
        <h2>Drill Stops & Retrieval Sets</h2>
        {% for did, item in drill_stop_retrieval.items() %}
        <div class="addon-row">
            <div>
                <div class="product-desc">{{ item.name }}</div>
                <div class="product-id">{{ did }}{% if item.notes %} Â· {{ item.notes }}{% endif %}</div>
            </div>
            <div class="product-price">${{ "{:,.0f}".format(item.price) }}</div>
            <input type="number" class="qty-input" name="qty_{{ did }}" min="0" value="0" onchange="updateCount()">
        </div>
        {% endfor %}
    </div>
    
    <!-- â•â•â• ALL OTHER PRODUCTS â•â•â• -->
    <div class="card">
        <h2>All Products <span class="selected-count" id="selectedCount">0 selected</span></h2>
        <p style="color:#666;margin:-8px 0 12px;font-size:13px;">Implants, abutments, regeneratives, digital equipment, and more.</p>
        <div class="quick-nav">
            <span class="quick-nav-label">Jump to:</span>
            {% for cat in categories %}
            {% if cat not in ['Surgical Kits', 'Motors'] %}
            <a href="#" onclick="jumpTo('{{ cat }}'); return false;">{{ cat.replace('Capital - ', '').split(' ')[0] }}</a>
            {% endif %}
            {% endfor %}
        </div>
        <div class="search-box">
            <input type="text" id="productSearch" placeholder="ðŸ” Search products by name or item #...">
        </div>
        
        {% for category, prods in products.items() %}
        {% if category not in ['Surgical Kits', 'Motors'] %}
        <div class="category-section" data-category="{{ category }}" id="cat-{{ category | replace(' ', '-') | replace('/', '-') }}">
            <div class="category-title" onclick="toggleCategory(this)">
                <span>{{ category }} ({{ prods|length }})</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="products-list">
                {% for prod in prods %}
                <div class="product-row" data-search="{{ prod.description|lower }} {{ prod.id|lower }}">
                    <div>
                        <div class="product-desc">{{ prod.description }}</div>
                        <div class="product-id">{{ prod.id }}</div>
                    </div>
                    <div class="product-price">${{ "{:,.0f}".format(prod.price) }}</div>
                    <input type="number" class="qty-input" name="qty_{{ prod.id }}" min="0" value="0" onchange="updateCount()">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <div class="card">
        <h2>Notes / Comments</h2>
        <div class="form-group">
            <label>Add notes or special terms (optional)</label>
            <textarea name="notes" id="notes" rows="3" style="resize: vertical;" placeholder="e.g., Pricing valid for 30 days."></textarea>
        </div>
    </div>
    
    <div class="card">
        <h2>Output Format</h2>
        <div class="output-options">
            <label class="output-option">
                <input type="radio" name="output_format" value="docx" checked>
                <span>ðŸ“„ Word (.docx)</span>
            </label>
            <label class="output-option">
                <input type="radio" name="output_format" value="pdf">
                <span>ðŸ“• PDF</span>
            </label>
        </div>
        <button type="submit" class="btn btn-primary btn-full">Generate Proposal</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
function applyPreset(preset) {
    const presets = {
        'standard': { Implants: 30, Abutments: 25, Kits: 20, Grafting: 20, Membranes: 20, Sutures: 15, '3Shape': 10, SprintRay: 10, DEXIS: 10, 'X_Guide': 10, iCAM: 10, DTX: 10, Other: 15 },
        'aggressive': { Implants: 40, Abutments: 35, Kits: 30, Grafting: 30, Membranes: 30, Sutures: 25, '3Shape': 15, SprintRay: 15, DEXIS: 15, 'X_Guide': 15, iCAM: 15, DTX: 15, Other: 25 },
        'light': { Implants: 20, Abutments: 15, Kits: 10, Grafting: 10, Membranes: 10, Sutures: 10, '3Shape': 5, SprintRay: 5, DEXIS: 5, 'X_Guide': 5, iCAM: 5, DTX: 5, Other: 10 },
        'clear': { Implants: 0, Abutments: 0, Kits: 0, Grafting: 0, Membranes: 0, Sutures: 0, '3Shape': 0, SprintRay: 0, DEXIS: 0, 'X_Guide': 0, iCAM: 0, DTX: 0, Other: 0 }
    };
    const values = presets[preset];
    if (!values) return;
    for (const [group, val] of Object.entries(values)) {
        const input = document.getElementById('discount_' + group);
        if (input) input.value = val;
    }
}

function jumpTo(categoryName) {
    const sections = document.querySelectorAll('.category-section');
    for (const section of sections) {
        if (section.dataset.category === categoryName) {
            section.querySelector('.products-list').classList.add('open');
            section.querySelector('.category-title').classList.add('open');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
    }
}

function toggleCategory(el) {
    el.classList.toggle('open');
    el.nextElementSibling.classList.toggle('open');
}

function updateCount() {
    let count = 0;
    document.querySelectorAll('.qty-input').forEach(input => {
        if (parseInt(input.value) > 0) count++;
    });
    document.getElementById('selectedCount').textContent = count + ' selected';
}

document.getElementById('productSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.product-row').forEach(row => {
        row.style.display = row.dataset.search && row.dataset.search.includes(query) ? '' : 'none';
    });
    document.querySelectorAll('.category-section').forEach(cat => {
        if (query && cat.querySelectorAll('.product-row:not([style*="display: none"])').length > 0) {
            cat.querySelector('.products-list').classList.add('open');
            cat.querySelector('.category-title').classList.add('open');
        }
    });
});

// â”€â”€ Save & Load Quotes â”€â”€
function saveQuote() {
    const formData = new FormData(document.getElementById('proposalForm'));
    const data = {
        account_name: formData.get('account_name') || 'Untitled',
        rep_name: formData.get('rep_name') || '',
        notes: formData.get('notes') || '',
        date: new Date().toISOString(),
        quantities: {},
        discounts: {}
    };
    document.querySelectorAll('.qty-input').forEach(input => {
        if (parseInt(input.value) > 0) {
            data.quantities[input.name] = input.value;
        }
    });
    document.querySelectorAll('.discount-item input').forEach(input => {
        if (parseInt(input.value) > 0) {
            data.discounts[input.name] = input.value;
        }
    });
    
    const id = (data.account_name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '') + '-' + Date.now()).substring(0, 50);
    data.id = id;
    
    fetch('/api/save_quote', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(r => r.json()).then(r => {
        document.getElementById('saveStatus').textContent = 'âœ… Saved: ' + data.account_name;
        setTimeout(() => document.getElementById('saveStatus').textContent = '', 3000);
    });
}

function loadQuoteList() {
    fetch('/api/list_quotes').then(r => r.json()).then(quotes => {
        const sel = document.getElementById('savedQuotes');
        sel.innerHTML = '<option value="">Select a saved quote...</option>';
        quotes.forEach(q => {
            const opt = document.createElement('option');
            opt.value = q.id;
            opt.textContent = q.account + ' (' + (q.date ? new Date(q.date).toLocaleDateString() : 'unknown') + ')';
            sel.appendChild(opt);
        });
        sel.style.display = 'inline-block';
    });
}

function loadQuote(quoteId) {
    if (!quoteId) return;
    fetch('/api/load_quote/' + quoteId).then(r => r.json()).then(data => {
        document.getElementById('account_name').value = data.account_name || '';
        document.getElementById('rep_name').value = data.rep_name || '';
        document.getElementById('notes').value = data.notes || '';
        
        // Reset all quantities
        document.querySelectorAll('.qty-input').forEach(input => input.value = 0);
        // Set saved quantities
        for (const [name, val] of Object.entries(data.quantities || {})) {
            const input = document.querySelector(`[name="${name}"]`);
            if (input) input.value = val;
        }
        // Set saved discounts
        for (const [name, val] of Object.entries(data.discounts || {})) {
            const input = document.querySelector(`[name="${name}"]`);
            if (input) input.value = val;
        }
        updateCount();
        document.getElementById('saveStatus').textContent = 'ðŸ“‚ Loaded: ' + (data.account_name || 'Quote');
    });
}

// Touch support for tooltips on mobile
document.querySelectorAll('.has-tooltip').forEach(el => {
    el.addEventListener('click', function(e) {
        const tip = this.querySelector('.tooltip-content');
        if (tip) {
            document.querySelectorAll('.tooltip-content.pinned').forEach(t => {
                if (t !== tip) t.classList.remove('pinned');
            });
            tip.classList.toggle('pinned');
        }
    });
});
</script>
{% endblock %}
