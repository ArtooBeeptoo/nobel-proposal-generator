{% extends "base.html" %}
{% block title %}New Surgical Starts - Nobel Biocare{% endblock %}

{% block extra_style %}
.implant-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
}
.implant-section h4 {
    color: #003087;
    margin: 0 0 10px;
    font-size: 15px;
}
.impl-row {
    display: grid;
    grid-template-columns: 1fr 80px 100px;
    gap: 12px;
    align-items: center;
    font-size: 13px;
}
.impl-row .price { color: #003087; font-weight: 600; text-align: right; }
.kit-option {
    background: #f8f9fa;
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
}
.kit-option:hover { background: #e8f0fe; }
.kit-option input { width: 18px; height: 18px; }
.calc-summary {
    background: #f0f7ff;
    border-radius: 8px;
    padding: 20px;
}
.calc-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 14px;
}
.calc-row.total {
    border-top: 2px solid #003087;
    margin-top: 8px;
    padding-top: 10px;
    font-weight: 700;
    font-size: 16px;
    color: #003087;
}
.calc-row.savings { color: #1a7a1a; font-weight: 600; }
.info-box {
    background: #e8f4fd;
    border-left: 4px solid #00A3E0;
    padding: 14px 18px;
    border-radius: 0 6px 6px 0;
    margin-bottom: 20px;
    font-size: 14px;
    color: #003087;
}
{% endblock %}

{% block content %}
<div class="card" style="border-left: 4px solid #00A3E0;">
    <h2 style="border-bottom: none; margin-bottom: 4px;">New Surgical Starts</h2>
    <p style="color: #555; font-size: 14px; margin: 0;">Minimum 10 implants â€¢ Up to 40% off list price â€¢ Full PureSet kit at no charge</p>
</div>

<div class="info-box">
    <strong>Rules:</strong> Minimum 10 implants (no max). Up to 40% discount. Customer receives a full PureSet kit at no charge â€” kit savings are shown in the total. You can mix implant types in one deal. Promo code: 81238
</div>

<form method="POST" action="{{ url_for('generate_new_start') }}" id="newStartForm">
    <div class="card">
        <h2>Account Details</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Account Name *</label>
                <input type="text" name="account_name" required placeholder="e.g., Smith Dental">
            </div>
            <div class="form-group">
                <label>Territory Manager</label>
                <input type="text" name="rep_name" placeholder="Your name">
            </div>
        </div>
        <div class="form-group" style="max-width: 300px;">
            <label>Discount % (max 40%)</label>
            <input type="number" name="discount_pct" id="discountPct" value="40" min="0" max="40" step="1" onchange="recalc()">
        </div>
    </div>
    
    <div class="card">
        <h2>Select Implants (Mix Types)</h2>
        <p style="color: #666; font-size: 13px; margin: -8px 0 16px;">Enter quantities for each implant type. Minimum total: 10 implants.</p>
        
        {% for cat_name, impl_list in implant_categories.items() %}
        <div class="implant-section">
            <h4>{{ cat_name }} â€” ${{ "{:,.0f}".format(impl_list[0].price) }}/ea list</h4>
            {% for impl in impl_list %}
            <div class="impl-row">
                <div>
                    <span>{{ impl.description }}</span>
                    <span style="color: #888; font-size: 11px;">({{ impl.id }})</span>
                </div>
                <div class="price">${{ "{:,.0f}".format(impl.price) }}</div>
                <input type="number" class="qty-input" name="impl_{{ impl.id }}" 
                       data-price="{{ impl.price }}" data-cat="{{ cat_name }}"
                       min="0" value="0" onchange="recalc()" 
                       style="width: 70px; padding: 6px; text-align: center; font-size: 13px;">
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        
        <div id="implantTotal" style="font-weight: 600; color: #003087; font-size: 15px; margin-top: 12px;">
            Total implants: 0
        </div>
    </div>
    
    <div class="card">
        <h2>Select PureSet Kit (at No Charge)</h2>
        <p style="color: #666; font-size: 13px; margin: -8px 0 16px;">Kit is included free â€” its value is shown as savings.</p>
        
        {% for kit in kits %}
        <label class="kit-option">
            <input type="radio" name="kit_id" value="{{ kit.id }}" data-price="{{ kit.price }}" 
                   {% if loop.first %}checked{% endif %} onchange="recalc()">
            <div>
                <div style="font-weight: 600; font-size: 14px;">{{ kit.description }}</div>
                <div style="color: #666; font-size: 12px;">{{ kit.id }} â€” List: ${{ "{:,.0f}".format(kit.price) }}</div>
            </div>
        </label>
        {% endfor %}
    </div>
    
    <div class="card">
        <h2>Pricing Summary</h2>
        <div class="calc-summary" id="calcSummary">
            <div class="calc-row"><span>Configure above to see pricing...</span></div>
        </div>
    </div>
    
    <div class="card">
        <h2>Notes</h2>
        <div class="form-group">
            <textarea name="notes" rows="2" placeholder="Special terms..."></textarea>
        </div>
    </div>
    
    <div class="card">
        <h2>Output Format</h2>
        <div style="display: flex; gap: 20px; margin: 12px 0;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="radio" name="output_format" value="docx" checked> ðŸ“„ Word (.docx)
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="radio" name="output_format" value="pdf"> ðŸ“• PDF
            </label>
        </div>
        <button type="submit" class="btn btn-primary btn-full" id="submitBtn">Generate New Start Proposal</button>
    </div>
</form>

<script>
function recalc() {
    const discount = Math.min(parseFloat(document.getElementById('discountPct').value) || 0, 40);
    const inputs = document.querySelectorAll('.qty-input');
    
    let totalImplants = 0;
    let totalList = 0;
    let totalDiscounted = 0;
    let breakdownHTML = '';
    const catTotals = {};
    
    inputs.forEach(input => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            const price = parseFloat(input.dataset.price);
            const cat = input.dataset.cat;
            totalImplants += qty;
            const listSub = price * qty;
            const discSub = listSub * (1 - discount / 100);
            totalList += listSub;
            totalDiscounted += discSub;
            
            if (!catTotals[cat]) catTotals[cat] = { qty: 0, list: 0, disc: 0 };
            catTotals[cat].qty += qty;
            catTotals[cat].list += listSub;
            catTotals[cat].disc += discSub;
        }
    });
    
    document.getElementById('implantTotal').innerHTML = `Total implants: <strong>${totalImplants}</strong>` + 
        (totalImplants < 10 ? ' <span style="color: #c00;">(minimum 10 required)</span>' : ' âœ“');
    
    const kitRadio = document.querySelector('input[name="kit_id"]:checked');
    const kitPrice = kitRadio ? parseFloat(kitRadio.dataset.price) : 0;
    
    let html = '';
    for (const [cat, data] of Object.entries(catTotals)) {
        html += `<div class="calc-row"><span>${data.qty}x ${cat} @ ${discount}% off</span><span>$${data.disc.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
    }
    
    html += `<div class="calc-row"><span>PureSet Kit (at no charge, value $${kitPrice.toLocaleString()})</span><span>$0</span></div>`;
    
    const grandTotal = totalDiscounted;
    const totalSavings = (totalList - totalDiscounted) + kitPrice;
    const savingsPct = (totalList + kitPrice) > 0 ? (totalSavings / (totalList + kitPrice) * 100).toFixed(1) : 0;
    
    html += `<div class="calc-row total"><span>Total Sale</span><span>$${grandTotal.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
    html += `<div class="calc-row savings"><span>Total Savings (incl. kit)</span><span>$${totalSavings.toLocaleString('en-US', {maximumFractionDigits: 0})}</span></div>`;
    html += `<div class="calc-row savings"><span>Savings %</span><span>${savingsPct}%</span></div>`;
    
    document.getElementById('calcSummary').innerHTML = html || '<div class="calc-row"><span>Add implants above to see pricing</span></div>';
    
    document.getElementById('submitBtn').disabled = totalImplants < 10;
}

document.addEventListener('DOMContentLoaded', recalc);
</script>
{% endblock %}
